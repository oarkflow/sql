<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETL Pipeline Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://unpkg.com/monaco-editor@0.44.0/min/vs/loader.js"></script>
    <script src="https://unpkg.com/@dagrejs/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/vis-network@9.1.6/dist/vis-network.min.js"></script>
    <link href="https://unpkg.com/vis-network@9.1.6/dist/dist/vis-network.min.css" rel="stylesheet">
</head>

<body class="bg-gradient-to-br from-purple-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900 mb-2">ETL Pipeline Management</h1>
                <p class="text-lg text-gray-600">Design, configure, and manage data transformation pipelines</p>
            </div>

            <!-- Navigation -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex flex-wrap justify-center space-x-4">
                    <a href="/"
                        class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition flex items-center">
                        <i data-lucide="home" class="w-4 h-4 mr-2"></i>
                        Dashboard
                    </a>
                    <a href="/integrations"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center">
                        <i data-lucide="plug" class="w-4 h-4 mr-2"></i>
                        Integrations
                    </a>
                    <a href="/etl"
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition flex items-center">
                        <i data-lucide="git-branch" class="w-4 h-4 mr-2"></i>
                        ETL Pipelines
                    </a>
                    <a href="/adapters"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center">
                        <i data-lucide="puzzle" class="w-4 h-4 mr-2"></i>
                        Adapters
                    </a>
                    <a href="/query"
                        class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition flex items-center">
                        <i data-lucide="database" class="w-4 h-4 mr-2"></i>
                        Query Editor
                    </a>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Pipeline List -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-2xl font-semibold text-gray-800 flex items-center">
                                <i data-lucide="git-branch" class="w-6 h-6 mr-2 text-purple-600"></i>
                                Pipelines
                            </h2>
                            <button id="addPipelineBtn"
                                class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-md transition duration-200 flex items-center">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                New
                            </button>
                        </div>

                        <div class="mb-4">
                            <input type="text" id="pipelineSearch" placeholder="Search pipelines..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>

                        <div id="pipelinesList" class="space-y-2 max-h-96 overflow-y-auto">
                            <!-- Pipelines will be populated here -->
                        </div>
                    </div>

                    <!-- Pipeline Info -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <i data-lucide="info" class="w-5 h-5 mr-2 text-blue-600"></i>
                            Pipeline Info
                        </h3>
                        <div id="pipelineInfo" class="space-y-2 text-sm">
                            <p class="text-gray-500">Select a pipeline to view details</p>
                        </div>
                    </div>
                </div>

                <!-- Pipeline Editor -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-2xl font-semibold text-gray-800 flex items-center">
                                <i data-lucide="edit-3" class="w-6 h-6 mr-2 text-green-600"></i>
                                Pipeline Designer
                            </h2>
                            <div class="flex space-x-2">
                                <button id="validateBtn"
                                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition duration-200 flex items-center">
                                    <i data-lucide="check-circle" class="w-4 h-4 mr-2"></i>
                                    Validate
                                </button>
                                <button id="saveBtn"
                                    class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md transition duration-200 flex items-center">
                                    <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                                    Save
                                </button>
                                <button id="runBtn"
                                    class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-4 rounded-md transition duration-200 flex items-center">
                                    <i data-lucide="play" class="w-4 h-4 mr-2"></i>
                                    Run
                                </button>
                            </div>
                        </div>

                        <!-- Tabs -->
                        <div class="border-b border-gray-200 mb-4">
                            <nav class="flex space-x-8">
                                <button id="visualTab"
                                    class="py-2 px-1 border-b-2 border-purple-500 text-purple-600 font-medium">
                                    Visual Designer
                                </button>
                                <button id="codeTab"
                                    class="py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                                    YAML Editor
                                </button>
                                <button id="scheduleTab"
                                    class="py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                                    Schedule
                                </button>
                            </nav>
                        </div>

                        <!-- Visual Designer -->
                        <div id="visualPanel" class="space-y-4">
                            <div class="flex space-x-4 mb-4">
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Pipeline Name</label>
                                    <input type="text" id="pipelineName" placeholder="Enter pipeline name"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                    <input type="text" id="pipelineDescription" placeholder="Enter description"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                            </div>

                            <!-- Node Palette -->
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-gray-800 mb-3">Node Palette</h3>
                                <div class="flex flex-wrap gap-2">
                                    <button
                                        class="node-btn px-3 py-2 bg-blue-100 text-blue-800 rounded-md hover:bg-blue-200 transition"
                                        data-node-type="source">
                                        <i data-lucide="database" class="w-4 h-4 inline mr-1"></i>
                                        Source
                                    </button>
                                    <button
                                        class="node-btn px-3 py-2 bg-green-100 text-green-800 rounded-md hover:bg-green-200 transition"
                                        data-node-type="transform">
                                        <i data-lucide="cpu" class="w-4 h-4 inline mr-1"></i>
                                        Transform
                                    </button>
                                    <button
                                        class="node-btn px-3 py-2 bg-purple-100 text-purple-800 rounded-md hover:bg-purple-200 transition"
                                        data-node-type="map">
                                        <i data-lucide="shuffle" class="w-4 h-4 inline mr-1"></i>
                                        Map
                                    </button>
                                    <button
                                        class="node-btn px-3 py-2 bg-orange-100 text-orange-800 rounded-md hover:bg-orange-200 transition"
                                        data-node-type="filter">
                                        <i data-lucide="filter" class="w-4 h-4 inline mr-1"></i>
                                        Filter
                                    </button>
                                    <button
                                        class="node-btn px-3 py-2 bg-red-100 text-red-800 rounded-md hover:bg-red-200 transition"
                                        data-node-type="load">
                                        <i data-lucide="upload" class="w-4 h-4 inline mr-1"></i>
                                        Load
                                    </button>
                                </div>
                            </div>

                            <!-- Canvas -->
                            <div class="border border-gray-200 rounded-lg p-4">
                                <div id="pipelineCanvas" style="height: 400px; border: 1px dashed #ccc;"></div>
                            </div>

                            <!-- Node Properties -->
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-gray-800 mb-3">Node Properties</h3>
                                <div id="nodeProperties" class="space-y-3">
                                    <p class="text-gray-500">Select a node to configure its properties</p>
                                </div>
                            </div>
                        </div>

                        <!-- YAML Editor -->
                        <div id="codePanel" class="hidden">
                            <div id="yamlEditor" style="height: 500px; border: 1px solid #ccc;"></div>
                        </div>

                        <!-- Schedule Panel -->
                        <div id="schedulePanel" class="hidden space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Schedule Type</label>
                                    <select id="scheduleType"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        <option value="manual">Manual</option>
                                        <option value="interval">Interval</option>
                                        <option value="cron">Cron Expression</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Schedule Value</label>
                                    <input type="text" id="scheduleValue" placeholder="e.g., 5m, 0 */6 * * *"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Time Zone</label>
                                <select id="timezone"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="UTC">UTC</option>
                                    <option value="America/New_York">America/New_York</option>
                                    <option value="Europe/London">Europe/London</option>
                                    <option value="Asia/Tokyo">Asia/Tokyo</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <input type="checkbox" id="enableRetry" class="mr-2">
                                    Enable Retry on Failure
                                </label>
                            </div>
                            <div id="retryOptions" class="hidden space-y-2">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Max Retries</label>
                                        <input type="number" id="maxRetries" value="3" min="0" max="10"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Retry Delay
                                            (seconds)</label>
                                        <input type="number" id="retryDelay" value="60" min="1"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Messages -->
            <div id="statusMessage" class="mt-8 hidden">
                <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded">
                    <div class="flex items-center">
                        <i data-lucide="info" class="w-5 h-5 mr-2"></i>
                        <span id="statusText"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Global variables
        let pipelines = [];
        let currentPipeline = null;
        let network = null;
        let nodes = null;
        let edges = null;
        let yamlEditor = null;
        let selectedNode = null;

        // DOM elements
        const pipelinesList = document.getElementById('pipelinesList');
        const pipelineSearch = document.getElementById('pipelineSearch');
        const pipelineInfo = document.getElementById('pipelineInfo');
        const visualTab = document.getElementById('visualTab');
        const codeTab = document.getElementById('codeTab');
        const scheduleTab = document.getElementById('scheduleTab');
        const visualPanel = document.getElementById('visualPanel');
        const codePanel = document.getElementById('codePanel');
        const schedulePanel = document.getElementById('schedulePanel');
        const statusMessage = document.getElementById('statusMessage');
        const statusText = document.getElementById('statusText');

        // Initialize Monaco Editor
        require.config({ paths: { vs: 'https://unpkg.com/monaco-editor@0.44.0/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            yamlEditor = monaco.editor.create(document.getElementById('yamlEditor'), {
                value: '# Pipeline Configuration\nsource:\n  type: file\n  path: data.csv\n\ntransform:\n  - type: filter\n    condition: "status == \'active\'"\n\nload:\n  type: database\n  table: output',
                language: 'yaml',
                theme: 'vs',
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                automaticLayout: true
            });

            yamlEditor.onDidChangeModelContent(() => {
                if (currentPipeline) {
                    currentPipeline.config = yamlEditor.getValue();
                }
            });
        });

        // Initialize Network Diagram
        function initNetwork() {
            const container = document.getElementById('pipelineCanvas');

            nodes = new vis.DataSet([
                { id: 1, label: 'Source', type: 'source', color: '#3B82F6', shape: 'box' },
                { id: 2, label: 'Transform', type: 'transform', color: '#10B981', shape: 'box' },
                { id: 3, label: 'Load', type: 'load', color: '#EF4444', shape: 'box' }
            ]);

            edges = new vis.DataSet([
                { from: 1, to: 2 },
                { from: 2, to: 3 }
            ]);

            const data = { nodes: nodes, edges: edges };
            const options = {
                layout: {
                    hierarchical: {
                        direction: 'LR',
                        sortMethod: 'directed',
                        levelSeparation: 150
                    }
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 200
                },
                manipulation: {
                    enabled: true,
                    addNode: function (data, callback) {
                        callback(data);
                    },
                    editNode: function (data, callback) {
                        callback(data);
                    },
                    deleteNode: function (data, callback) {
                        callback(data);
                    },
                    addEdge: function (data, callback) {
                        callback(data);
                    },
                    deleteEdge: function (data, callback) {
                        callback(data);
                    }
                }
            };

            network = new vis.Network(container, data, options);

            network.on("click", function (params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    const node = nodes.get(nodeId);
                    selectNode(node);
                } else {
                    deselectNode();
                }
            });
        }

        // Load pipelines
        async function loadPipelines() {
            try {
                const response = await fetch('/api/pipelines');
                pipelines = await response.json();
                renderPipelines();
            } catch (error) {
                console.error('Failed to load pipelines:', error);
                showStatus('Failed to load pipelines', 'error');
            }
        }

        // Render pipelines list
        function renderPipelines() {
            const searchTerm = pipelineSearch.value.toLowerCase();
            const filteredPipelines = pipelines.filter(pipeline =>
                pipeline.name.toLowerCase().includes(searchTerm) ||
                pipeline.description.toLowerCase().includes(searchTerm)
            );

            if (filteredPipelines.length === 0) {
                pipelinesList.innerHTML = '<p class="text-gray-500 text-center py-4">No pipelines found</p>';
                return;
            }

            pipelinesList.innerHTML = filteredPipelines.map(pipeline => createPipelineElement(pipeline)).join('');
            lucide.createIcons();
        }

        // Create pipeline element
        function createPipelineElement(pipeline) {
            const statusColor = getStatusColor(pipeline.status);
            return `
                <div class="border border-gray-200 rounded-lg p-3 hover:bg-gray-50 cursor-pointer transition duration-200"
                     onclick="selectPipeline('${pipeline.id}')">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-semibold text-gray-800">${pipeline.name}</span>
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColor}">
                            ${pipeline.status}
                        </span>
                    </div>
                    <div class="text-sm text-gray-600 mb-1">
                        ${pipeline.description || 'No description'}
                    </div>
                    <div class="text-xs text-gray-500">
                        Last run: ${pipeline.lastRun ? new Date(pipeline.lastRun).toLocaleDateString() : 'Never'}
                    </div>
                </div>
            `;
        }

        // Get status color
        function getStatusColor(status) {
            switch (status) {
                case 'running': return 'bg-blue-100 text-blue-800';
                case 'completed': return 'bg-green-100 text-green-800';
                case 'failed': return 'bg-red-100 text-red-800';
                case 'paused': return 'bg-yellow-100 text-yellow-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Select pipeline
        async function selectPipeline(id) {
            try {
                const response = await fetch(`/api/pipelines/${id}`);
                currentPipeline = await response.json();

                // Update form fields
                document.getElementById('pipelineName').value = currentPipeline.name;
                document.getElementById('pipelineDescription').value = currentPipeline.description || '';

                // Update YAML editor
                if (yamlEditor) {
                    yamlEditor.setValue(currentPipeline.config || '');
                }

                // Update schedule info
                if (currentPipeline.schedule) {
                    document.getElementById('scheduleType').value = currentPipeline.schedule.type || 'manual';
                    document.getElementById('scheduleValue').value = currentPipeline.schedule.value || '';
                    document.getElementById('timezone').value = currentPipeline.schedule.timezone || 'UTC';
                    document.getElementById('enableRetry').checked = currentPipeline.schedule.retry || false;

                    if (currentPipeline.schedule.retry) {
                        document.getElementById('retryOptions').classList.remove('hidden');
                        document.getElementById('maxRetries').value = currentPipeline.schedule.maxRetries || 3;
                        document.getElementById('retryDelay').value = currentPipeline.schedule.retryDelay || 60;
                    }
                }

                // Update pipeline info
                updatePipelineInfo();

                // Highlight selected pipeline
                document.querySelectorAll('#pipelinesList > div').forEach(el => {
                    el.classList.remove('ring-2', 'ring-purple-500');
                });
                event.currentTarget.classList.add('ring-2', 'ring-purple-500');
            } catch (error) {
                console.error('Failed to load pipeline:', error);
                showStatus('Failed to load pipeline', 'error');
            }
        }

        // Update pipeline info
        function updatePipelineInfo() {
            if (!currentPipeline) {
                pipelineInfo.innerHTML = '<p class="text-gray-500">Select a pipeline to view details</p>';
                return;
            }

            pipelineInfo.innerHTML = `
                <div class="space-y-2">
                    <div><strong>ID:</strong> ${currentPipeline.id}</div>
                    <div><strong>Status:</strong> <span class="px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(currentPipeline.status)}">${currentPipeline.status}</span></div>
                    <div><strong>Created:</strong> ${new Date(currentPipeline.createdAt).toLocaleDateString()}</div>
                    <div><strong>Last Run:</strong> ${currentPipeline.lastRun ? new Date(currentPipeline.lastRun).toLocaleString() : 'Never'}</div>
                    <div><strong>Nodes:</strong> ${currentPipeline.nodes ? currentPipeline.nodes.length : 0}</div>
                    ${currentPipeline.schedule ? `
                        <div><strong>Schedule:</strong> ${currentPipeline.schedule.type} ${currentPipeline.schedule.value || ''}</div>
                    ` : ''}
                </div>
            `;
        }

        // Select node
        function selectNode(node) {
            selectedNode = node;
            const nodeProperties = document.getElementById('nodeProperties');

            let propertiesHTML = `
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Node ID</label>
                        <input type="text" value="${node.id}" readonly
                            class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Label</label>
                        <input type="text" id="nodeLabel" value="${node.label}"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                        <select id="nodeType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="source" ${node.type === 'source' ? 'selected' : ''}>Source</option>
                            <option value="transform" ${node.type === 'transform' ? 'selected' : ''}>Transform</option>
                            <option value="map" ${node.type === 'map' ? 'selected' : ''}>Map</option>
                            <option value="filter" ${node.type === 'filter' ? 'selected' : ''}>Filter</option>
                            <option value="load" ${node.type === 'load' ? 'selected' : ''}>Load</option>
                        </select>
                    </div>
            `;

            // Add type-specific properties
            switch (node.type) {
                case 'source':
                    propertiesHTML += `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Source Type</label>
                            <select id="sourceType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="file">File</option>
                                <option value="database">Database</option>
                                <option value="api">API</option>
                                <option value="stream">Stream</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Connection</label>
                            <input type="text" id="sourceConnection" placeholder="Connection string or path"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                    `;
                    break;
                case 'transform':
                    propertiesHTML += `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Transformation</label>
                            <textarea id="transformExpression" rows="3" placeholder="Enter transformation logic"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                        </div>
                    `;
                    break;
                case 'load':
                    propertiesHTML += `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Target Type</label>
                            <select id="loadType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="file">File</option>
                                <option value="database">Database</option>
                                <option value="api">API</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Target</label>
                            <input type="text" id="loadTarget" placeholder="Target destination"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                    `;
                    break;
            }

            propertiesHTML += `
                    <div class="flex space-x-2">
                        <button onclick="updateNode()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition duration-200">
                            Update
                        </button>
                        <button onclick="deleteNode()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md transition duration-200">
                            Delete
                        </button>
                    </div>
                </div>
            `;

            nodeProperties.innerHTML = propertiesHTML;
        }

        // Deselect node
        function deselectNode() {
            selectedNode = null;
            document.getElementById('nodeProperties').innerHTML = '<p class="text-gray-500">Select a node to configure its properties</p>';
        }

        // Update node
        function updateNode() {
            if (!selectedNode) return;

            const label = document.getElementById('nodeLabel').value;
            const type = document.getElementById('nodeType').value;

            nodes.update({
                id: selectedNode.id,
                label: label,
                type: type,
                color: getNodeColor(type)
            });

            deselectNode();
            showStatus('Node updated successfully', 'success');
        }

        // Delete node
        function deleteNode() {
            if (!selectedNode) return;

            if (confirm('Are you sure you want to delete this node?')) {
                nodes.remove(selectedNode.id);
                deselectNode();
                showStatus('Node deleted successfully', 'success');
            }
        }

        // Get node color
        function getNodeColor(type) {
            switch (type) {
                case 'source': return '#3B82F6';
                case 'transform': return '#10B981';
                case 'map': return '#8B5CF6';
                case 'filter': return '#F59E0B';
                case 'load': return '#EF4444';
                default: return '#6B7280';
            }
        }

        // Show status message
        function showStatus(message, type) {
            statusText.textContent = message;
            statusMessage.className = 'mt-8';

            if (type === 'error') {
                statusMessage.innerHTML = `
                    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded">
                        <div class="flex items-center">
                            <i data-lucide="alert-circle" class="w-5 h-5 mr-2"></i>
                            <span>${message}</span>
                        </div>
                    </div>
                `;
            } else if (type === 'success') {
                statusMessage.innerHTML = `
                    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded">
                        <div class="flex items-center">
                            <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>
                            <span>${message}</span>
                        </div>
                    </div>
                `;
            } else {
                statusMessage.innerHTML = `
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded">
                        <div class="flex items-center">
                            <i data-lucide="info" class="w-5 h-5 mr-2"></i>
                            <span>${message}</span>
                        </div>
                    </div>
                `;
            }

            lucide.createIcons();

            setTimeout(() => {
                statusMessage.className = 'mt-8 hidden';
            }, 5000);
        }

        // Event listeners
        document.getElementById('addPipelineBtn').addEventListener('click', () => {
            currentPipeline = {
                id: 'new-' + Date.now(),
                name: 'New Pipeline',
                description: '',
                status: 'draft',
                config: '# Pipeline Configuration\nsource:\n  type: file\n  path: data.csv\n\ntransform:\n  - type: filter\n    condition: "status == \'active\'"\n\nload:\n  type: database\n  table: output',
                nodes: [],
                schedule: null
            };

            document.getElementById('pipelineName').value = currentPipeline.name;
            document.getElementById('pipelineDescription').value = currentPipeline.description;

            if (yamlEditor) {
                yamlEditor.setValue(currentPipeline.config);
            }

            updatePipelineInfo();
        });

        document.getElementById('validateBtn').addEventListener('click', async () => {
            if (!currentPipeline) {
                showStatus('Please select or create a pipeline first', 'error');
                return;
            }

            try {
                showStatus('Validating pipeline...', 'info');

                // Basic validation
                const config = yamlEditor ? yamlEditor.getValue() : '';
                if (!config.trim()) {
                    showStatus('Pipeline configuration cannot be empty', 'error');
                    return;
                }

                // Check if nodes are connected
                if (nodes && nodes.length > 0) {
                    const nodeIds = nodes.getIds();
                    const edgeIds = edges.getIds();

                    if (nodeIds.length > 1 && edgeIds.length === 0) {
                        showStatus('Pipeline nodes are not connected', 'error');
                        return;
                    }
                }

                showStatus('Pipeline validation successful', 'success');
            } catch (error) {
                console.error('Pipeline validation failed:', error);
                showStatus('Pipeline validation failed: ' + error.message, 'error');
            }
        });

        document.getElementById('saveBtn').addEventListener('click', async () => {
            if (!currentPipeline) {
                showStatus('Please select or create a pipeline first', 'error');
                return;
            }

            try {
                const pipelineData = {
                    name: document.getElementById('pipelineName').value,
                    description: document.getElementById('pipelineDescription').value,
                    config: yamlEditor ? yamlEditor.getValue() : '',
                    nodes: nodes ? nodes.get() : [],
                    edges: edges ? edges.get() : [],
                    schedule: {
                        type: document.getElementById('scheduleType').value,
                        value: document.getElementById('scheduleValue').value,
                        timezone: document.getElementById('timezone').value,
                        retry: document.getElementById('enableRetry').checked,
                        maxRetries: document.getElementById('maxRetries').value,
                        retryDelay: document.getElementById('retryDelay').value
                    }
                };

                const url = currentPipeline.id.startsWith('new-') ? '/api/pipelines' : `/api/pipelines/${currentPipeline.id}`;
                const method = currentPipeline.id.startsWith('new-') ? 'POST' : 'PUT';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(pipelineData)
                });

                if (response.ok) {
                    const savedPipeline = await response.json();
                    showStatus('Pipeline saved successfully', 'success');

                    if (currentPipeline.id.startsWith('new-')) {
                        currentPipeline = savedPipeline;
                    }

                    loadPipelines();
                    updatePipelineInfo();
                } else {
                    const result = await response.json();
                    showStatus('Failed to save pipeline: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Failed to save pipeline:', error);
                showStatus('Failed to save pipeline', 'error');
            }
        });

        document.getElementById('runBtn').addEventListener('click', async () => {
            if (!currentPipeline || currentPipeline.id.startsWith('new-')) {
                showStatus('Please save the pipeline first', 'error');
                return;
            }

            try {
                showStatus('Starting pipeline execution...', 'info');

                const response = await fetch(`/api/pipelines/${currentPipeline.id}/run`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    showStatus('Pipeline execution started with ID: ' + result.runId, 'success');
                    currentPipeline.status = 'running';
                    updatePipelineInfo();
                    renderPipelines();
                } else {
                    const result = await response.json();
                    showStatus('Failed to start pipeline: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Failed to run pipeline:', error);
                showStatus('Failed to run pipeline', 'error');
            }
        });

        // Tab switching
        visualTab.addEventListener('click', () => {
            visualTab.classList.add('border-purple-500', 'text-purple-600');
            visualTab.classList.remove('border-transparent', 'text-gray-500');
            codeTab.classList.remove('border-purple-500', 'text-purple-600');
            codeTab.classList.add('border-transparent', 'text-gray-500');
            scheduleTab.classList.remove('border-purple-500', 'text-purple-600');
            scheduleTab.classList.add('border-transparent', 'text-gray-500');

            visualPanel.classList.remove('hidden');
            codePanel.classList.add('hidden');
            schedulePanel.classList.add('hidden');
        });

        codeTab.addEventListener('click', () => {
            codeTab.classList.add('border-purple-500', 'text-purple-600');
            codeTab.classList.remove('border-transparent', 'text-gray-500');
            visualTab.classList.remove('border-purple-500', 'text-purple-600');
            visualTab.classList.add('border-transparent', 'text-gray-500');
            scheduleTab.classList.remove('border-purple-500', 'text-purple-600');
            scheduleTab.classList.add('border-transparent', 'text-gray-500');

            codePanel.classList.remove('hidden');
            visualPanel.classList.add('hidden');
            schedulePanel.classList.add('hidden');
        });

        scheduleTab.addEventListener('click', () => {
            scheduleTab.classList.add('border-purple-500', 'text-purple-600');
            scheduleTab.classList.remove('border-transparent', 'text-gray-500');
            visualTab.classList.remove('border-purple-500', 'text-purple-600');
            visualTab.classList.add('border-transparent', 'text-gray-500');
            codeTab.classList.remove('border-purple-500', 'text-purple-600');
            codeTab.classList.add('border-transparent', 'text-gray-500');

            schedulePanel.classList.remove('hidden');
            visualPanel.classList.add('hidden');
            codePanel.classList.add('hidden');
        });

        // Node palette buttons
        document.querySelectorAll('.node-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const nodeType = btn.dataset.nodeType;
                const newNode = {
                    id: 'node-' + Date.now(),
                    label: nodeType.charAt(0).toUpperCase() + nodeType.slice(1),
                    type: nodeType,
                    color: getNodeColor(nodeType),
                    shape: 'box'
                };

                nodes.add(newNode);
                showStatus(`Added ${nodeType} node`, 'success');
            });
        });

        // Schedule options
        document.getElementById('enableRetry').addEventListener('change', (e) => {
            if (e.target.checked) {
                document.getElementById('retryOptions').classList.remove('hidden');
            } else {
                document.getElementById('retryOptions').classList.add('hidden');
            }
        });

        // Search
        pipelineSearch.addEventListener('input', renderPipelines);

        // Initialize
        initNetwork();
        loadPipelines();
    </script>
</body>

</html>
