<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integration Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://unpkg.com/monaco-editor@0.44.0/min/vs/loader.js"></script>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-7xl mx-auto">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900 mb-2">Integration Management</h1>
                <p class="text-lg text-gray-600">Configure and manage data integrations</p>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex flex-wrap justify-center gap-4">
                    <a href="/"
                        class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition flex items-center">
                        <i data-lucide="home" class="w-4 h-4 mr-2"></i>
                        Dashboard
                    </a>
                    <a href="/integrations"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center">
                        <i data-lucide="plug" class="w-4 h-4 mr-2"></i>
                        Integrations
                    </a>
                    <a href="/etl"
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition flex items-center">
                        <i data-lucide="git-branch" class="w-4 h-4 mr-2"></i>
                        ETL Pipelines
                    </a>
                    <a href="/adapters"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center">
                        <i data-lucide="puzzle" class="w-4 h-4 mr-2"></i>
                        Adapters
                    </a>
                    <a href="/query"
                        class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition flex items-center">
                        <i data-lucide="database" class="w-4 h-4 mr-2"></i>
                        Query Editor
                    </a>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-2xl font-semibold text-gray-800 flex items-center">
                                <i data-lucide="plug" class="w-6 h-6 mr-2 text-blue-600"></i>
                                Integrations
                            </h2>
                            <button id="addIntegrationBtn"
                                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition duration-200 flex items-center">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                Add Integration
                            </button>
                        </div>

                        <div class="mb-4 flex flex-col sm:flex-row gap-4">
                            <div class="flex-1">
                                <input type="text" id="searchInput" placeholder="Search integrations..."
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <select id="typeFilter"
                                class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">All Types</option>
                            </select>
                        </div>

                        <div id="integrationsList" class="space-y-4 max-h-96 overflow-y-auto">
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-1">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                            <i data-lucide="settings" class="w-6 h-6 mr-2 text-green-600"></i>
                            Configuration
                        </h2>

                        <form id="integrationForm" class="space-y-4">
                            <input type="hidden" id="integrationId" value="">

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Name</label>
                                <input type="text" id="integrationName" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                                <select id="integrationType" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Select Type</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                <textarea id="integrationDescription" rows="3"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <input type="checkbox" id="requireAuth" class="mr-2">
                                    Requires Authentication
                                </label>
                            </div>

                            <div id="credentialSection" class="hidden space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Credential Type</label>
                                    <select id="credentialType"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Select Type</option>
                                        <option value="api_key">API Key</option>
                                        <option value="bearer">Bearer Token</option>
                                        <option value="basic">Basic Auth</option>
                                        <option value="oauth2">OAuth 2.0</option>
                                    </select>
                                </div>
                                <div id="credentialFields" class="space-y-2"></div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Configuration</label>
                                <div id="configEditor" style="height: 200px; border: 1px solid #ccc;"></div>
                            </div>

                            <div class="flex space-x-2">
                                <button type="submit"
                                    class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md transition duration-200">
                                    <i data-lucide="save" class="w-4 h-4 mr-2 inline"></i>
                                    Save
                                </button>
                                <button type="button" id="testBtn"
                                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition duration-200">
                                    <i data-lucide="play" class="w-4 h-4 mr-2 inline"></i>
                                    Test
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="statusMessage" class="mt-8 hidden">
                <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded">
                    <div class="flex items-center">
                        <i data-lucide="info" class="w-5 h-5 mr-2"></i>
                        <span id="statusText"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        let integrations = [];
        let configEditor;
        let oauthProviders = [];
        let oauthPollHandle = null;
        let currentOAuthState = null;
        let oauthPopup = null;

        const integrationsList = document.getElementById('integrationsList');
        const integrationForm = document.getElementById('integrationForm');
        const integrationIdInput = document.getElementById('integrationId');
        const integrationNameInput = document.getElementById('integrationName');
        const integrationTypeSelect = document.getElementById('integrationType');
        const integrationDescriptionInput = document.getElementById('integrationDescription');
        const addIntegrationBtn = document.getElementById('addIntegrationBtn');
        const testBtn = document.getElementById('testBtn');
        const searchInput = document.getElementById('searchInput');
        const typeFilter = document.getElementById('typeFilter');
        const requireAuth = document.getElementById('requireAuth');
        const credentialSection = document.getElementById('credentialSection');
        const credentialType = document.getElementById('credentialType');
        const credentialFields = document.getElementById('credentialFields');
        const statusMessage = document.getElementById('statusMessage');
        const statusText = document.getElementById('statusText');

        const SERVICE_TYPES = [
            { value: 'rest', label: 'REST / HTTP API', icon: 'globe' },
            { value: 'graphql', label: 'GraphQL API', icon: 'code-2' },
            { value: 'soap', label: 'SOAP Service', icon: 'file-code' },
            { value: 'grpc', label: 'gRPC Service', icon: 'share-2' },
            { value: 'database', label: 'Database', icon: 'database' },
            { value: 'smtp', label: 'SMTP Email', icon: 'mail' },
            { value: 'smpp', label: 'SMPP Messaging', icon: 'message-circle' },
            { value: 'kafka', label: 'Kafka', icon: 'radio' },
            { value: 'mqtt', label: 'MQTT', icon: 'rss' },
            { value: 'ftp', label: 'FTP', icon: 'upload-cloud' },
            { value: 'sftp', label: 'SFTP', icon: 'shield' },
            { value: 'push', label: 'Push Notification', icon: 'bell' },
            { value: 'slack', label: 'Slack', icon: 'slack' },
            { value: 'custom_tcp', label: 'Custom TCP', icon: 'server' },
            { value: 'voip', label: 'VoIP', icon: 'phone-call' },
            { value: 'webcrawler', label: 'Web Crawler', icon: 'bug' }
        ];

        function populateServiceTypeOptions() {
            if (!integrationTypeSelect || !typeFilter) {
                return;
            }
            SERVICE_TYPES.forEach(({ value, label }) => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = label;
                integrationTypeSelect.appendChild(option);

                const filterOption = document.createElement('option');
                filterOption.value = value;
                filterOption.textContent = label;
                typeFilter.appendChild(filterOption);
            });
        }

        function capitalize(word) {
            if (!word) {
                return '';
            }
            return word.charAt(0).toUpperCase() + word.slice(1);
        }

        function getTypeMeta(type) {
            const normalized = (type || '').toLowerCase();
            const meta = SERVICE_TYPES.find((item) => item.value === normalized);
            if (meta) {
                return meta;
            }
            const fallbackLabel = normalized
                ? normalized.split(/[-_]/).map((part) => capitalize(part)).join(' ')
                : 'Unknown';
            return {
                value: normalized,
                label: fallbackLabel,
                icon: 'plug'
            };
        }

        populateServiceTypeOptions();

        require.config({ paths: { vs: 'https://unpkg.com/monaco-editor@0.44.0/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            configEditor = monaco.editor.create(document.getElementById('configEditor'), {
                value: '{\n  \n}',
                language: 'json',
                theme: 'vs',
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                automaticLayout: true
            });
        });

        async function loadIntegrations() {
            try {
                const response = await fetch('/api/integrations');
                const payload = await response.json();
                if (!response.ok) {
                    throw new Error(payload.error || 'Failed to load integrations');
                }
                integrations = payload;
                renderIntegrations();
            } catch (error) {
                console.error('Failed to load integrations:', error);
                showStatus('Failed to load integrations', 'error');
            }
        }

        function renderIntegrations() {
            const searchTerm = searchInput.value.toLowerCase();
            const typeValue = typeFilter.value;

            const filteredIntegrations = integrations.filter((integration) => {
                const name = (integration.name || '').toLowerCase();
                const description = (integration.description || '').toLowerCase();
                const type = (integration.type || '').toLowerCase();
                const matchesSearch = name.includes(searchTerm) || description.includes(searchTerm);
                const matchesType = !typeValue || type === typeValue;
                return matchesSearch && matchesType;
            });

            if (filteredIntegrations.length === 0) {
                integrationsList.innerHTML = '<p class="text-gray-500 text-center py-8">No integrations found</p>';
                return;
            }

            integrationsList.innerHTML = filteredIntegrations.map(createIntegrationElement).join('');
            lucide.createIcons();
        }

        function createIntegrationElement(integration) {
            const statusColor = getStatusColor(integration.status);
            const typeMeta = getTypeMeta(integration.type);
            const description = integration.description || 'No description provided';
            const createdLabel = integration.createdAt ? new Date(integration.createdAt).toLocaleDateString() : 'N/A';
            const statusLabel = integration.status || 'pending';
            const displayName = integration.name || 'Unnamed Integration';

            return `
                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition duration-200">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center">
                            <i data-lucide="${typeMeta.icon}" class="w-5 h-5 mr-2 text-gray-600"></i>
                            <span class="font-semibold text-gray-800">${displayName}</span>
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColor}">
                            ${statusLabel}
                        </span>
                    </div>
                    <div class="text-sm text-gray-600 mb-2">
                        ${description}
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="text-xs text-gray-500">
                            Type: ${typeMeta.label} | Created: ${createdLabel}
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editIntegration('${integration.id}')" class="text-blue-600 hover:text-blue-800">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button onclick="testIntegration('${integration.id}')" class="text-green-600 hover:text-green-800">
                                <i data-lucide="play" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteIntegration('${integration.id}')" class="text-red-600 hover:text-red-800">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function getStatusColor(status) {
            switch ((status || '').toLowerCase()) {
                case 'connected':
                    return 'bg-green-100 text-green-800';
                case 'disconnected':
                    return 'bg-red-100 text-red-800';
                case 'pending':
                    return 'bg-yellow-100 text-yellow-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        async function editIntegration(id) {
            try {
                const response = await fetch(`/api/integrations/${id}`);
                const integration = await response.json();

                integrationIdInput.value = integration.id;
                integrationNameInput.value = integration.name;
                integrationTypeSelect.value = integration.type;
                integrationDescriptionInput.value = integration.description || '';
                requireAuth.checked = integration.requireAuth;

                if (integration.requireAuth) {
                    credentialSection.classList.remove('hidden');
                    updateCredentialFields();
                } else {
                    credentialSection.classList.add('hidden');
                    credentialFields.innerHTML = '';
                }

                if (configEditor) {
                    configEditor.setValue(JSON.stringify(integration.config, null, 2));
                }

                integrationForm.scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Failed to load integration:', error);
                showStatus('Failed to load integration', 'error');
            }
        }

        async function testIntegration(id) {
            try {
                showStatus('Testing integration...', 'info');
                const response = await fetch(`/api/integrations/${id}/test`, { method: 'POST' });
                const result = await response.json();

                if (response.ok) {
                    showStatus('Integration test successful', 'success');
                } else {
                    showStatus(`Integration test failed: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Failed to test integration:', error);
                showStatus('Failed to test integration', 'error');
            }
        }

        async function deleteIntegration(id) {
            if (!confirm('Are you sure you want to delete this integration?')) {
                return;
            }

            try {
                const response = await fetch(`/api/integrations/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    showStatus('Integration deleted successfully', 'success');
                    loadIntegrations();
                } else {
                    const result = await response.json();
                    showStatus(`Failed to delete integration: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Failed to delete integration:', error);
                showStatus('Failed to delete integration', 'error');
            }
        }

        function updateCredentialFields() {
            const type = credentialType.value;
            let fieldsHTML = '';

            switch (type) {
                case 'api_key':
                    fieldsHTML = `
                        <input type="text" id="apiKey" placeholder="API Key"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    `;
                    break;
                case 'bearer':
                    fieldsHTML = `
                        <input type="text" id="bearerToken" placeholder="Bearer Token"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    `;
                    break;
                case 'basic':
                    fieldsHTML = `
                        <input type="text" id="username" placeholder="Username"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="password" id="password" placeholder="Password"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    `;
                    break;
                case 'oauth2':
                    fieldsHTML = `
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Provider Template</label>
                                <select id="oauthProvider"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Custom Provider</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Use presets for Google, GitHub, Facebook, or define your own endpoints.</p>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <input type="text" id="clientId" placeholder="Client ID"
                                    class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <input type="text" id="clientSecret" placeholder="Client Secret"
                                    class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Authorization URL</label>
                                <input type="text" id="oauthAuthUrl" placeholder="https://provider.com/oauth/authorize"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Token URL</label>
                                <input type="text" id="oauthTokenUrl" placeholder="https://provider.com/oauth/token"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Scopes</label>
                                <input type="text" id="oauthScopes" placeholder="space separated scopes"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Redirect URI</label>
                                <input type="text" id="oauthRedirectUri" placeholder="https://your-host/oauth/callback"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <p class="text-xs text-gray-500 mt-1">Must match the redirect configured with the provider.</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <button type="button" id="oauthConnectBtn"
                                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md transition duration-200">
                                    Connect &amp; Authorize
                                </button>
                                <span id="oauthStatus" class="text-sm text-gray-500">Not connected</span>
                            </div>
                            <input type="hidden" id="oauthAccessToken">
                            <input type="hidden" id="oauthRefreshToken">
                            <input type="hidden" id="oauthGrantedScope">
                            <input type="hidden" id="oauthExpiresAt">
                            <input type="hidden" id="oauthProviderName">
                        </div>
                    `;
                    break;
                default:
                    fieldsHTML = '';
            }

            credentialFields.innerHTML = fieldsHTML;

            if (type === 'oauth2') {
                setupOAuthFields();
            } else {
                resetOAuthState();
            }
        }

        function fillOAuthProviderOptions(selectEl) {
            if (!selectEl) {
                return;
            }
            const currentValue = selectEl.value;
            selectEl.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Custom Provider';
            selectEl.appendChild(defaultOption);
            oauthProviders.forEach((provider) => {
                const option = document.createElement('option');
                option.value = provider.name;
                option.textContent = provider.displayName;
                if (currentValue && provider.name === currentValue) {
                    option.selected = true;
                }
                selectEl.appendChild(option);
            });
        }

        function setupOAuthFields() {
            const providerSelect = document.getElementById('oauthProvider');
            fillOAuthProviderOptions(providerSelect);
            if (providerSelect) {
                providerSelect.addEventListener('change', () => applyOAuthTemplate(providerSelect.value));
            }
            const redirectInput = document.getElementById('oauthRedirectUri');
            if (redirectInput && !redirectInput.value) {
                redirectInput.value = `${window.location.origin}/oauth/callback`;
            }
            const connectBtn = document.getElementById('oauthConnectBtn');
            if (connectBtn) {
                connectBtn.addEventListener('click', startOAuthFlow);
            }
            updateOAuthStatus('Not connected', 'idle');
        }

        function applyOAuthTemplate(name) {
            resetOAuthState();
            if (!name) {
                return;
            }
            const provider = oauthProviders.find((tpl) => tpl.name === name);
            if (!provider) {
                return;
            }
            const authInput = document.getElementById('oauthAuthUrl');
            const tokenInput = document.getElementById('oauthTokenUrl');
            const scopeInput = document.getElementById('oauthScopes');
            if (authInput) {
                authInput.value = provider.authUrl || '';
            }
            if (tokenInput) {
                tokenInput.value = provider.tokenUrl || '';
            }
            if (scopeInput && !scopeInput.value) {
                scopeInput.value = provider.scope || '';
            }
            const providerHidden = document.getElementById('oauthProviderName');
            if (providerHidden) {
                providerHidden.value = provider.name;
            }
        }

        function resetOAuthState() {
            if (oauthPollHandle) {
                clearInterval(oauthPollHandle);
                oauthPollHandle = null;
            }
            currentOAuthState = null;
            if (oauthPopup && !oauthPopup.closed) {
                oauthPopup.close();
            }
            ['oauthAccessToken', 'oauthRefreshToken', 'oauthGrantedScope', 'oauthExpiresAt', 'oauthProviderName'].forEach((id) => {
                const el = document.getElementById(id);
                if (el) {
                    el.value = '';
                }
            });
            updateOAuthStatus('Not connected', 'idle');
        }

        function updateOAuthStatus(message, tone = 'idle') {
            const statusEl = document.getElementById('oauthStatus');
            if (!statusEl) {
                return;
            }
            const palette = {
                idle: 'text-gray-500',
                pending: 'text-yellow-600',
                success: 'text-green-600',
                error: 'text-red-600'
            };
            statusEl.textContent = message;
            statusEl.className = `text-sm ${palette[tone] || palette.idle}`;
        }

        async function loadOAuthProviders() {
            try {
                const response = await fetch('/api/oauth/providers');
                if (!response.ok) {
                    throw new Error('failed to load OAuth providers');
                }
                oauthProviders = await response.json();
                fillOAuthProviderOptions(document.getElementById('oauthProvider'));
            } catch (error) {
                console.warn('Unable to fetch OAuth providers', error);
                oauthProviders = [];
            }
        }

        async function startOAuthFlow() {
            const providerSelect = document.getElementById('oauthProvider');
            const clientIdInput = document.getElementById('clientId');
            const clientSecretInput = document.getElementById('clientSecret');
            const authUrlInput = document.getElementById('oauthAuthUrl');
            const tokenUrlInput = document.getElementById('oauthTokenUrl');
            const scopeInput = document.getElementById('oauthScopes');
            const redirectInput = document.getElementById('oauthRedirectUri');

            if (!clientIdInput || !authUrlInput || !tokenUrlInput) {
                showStatus('OAuth fields missing from form', 'error');
                return;
            }

            const clientId = clientIdInput.value.trim();
            if (!clientId) {
                showStatus('Client ID is required for OAuth', 'error');
                return;
            }

            const payload = {
                provider: providerSelect ? providerSelect.value : '',
                clientId,
                clientSecret: clientSecretInput ? clientSecretInput.value.trim() : '',
                authUrl: authUrlInput.value.trim(),
                tokenUrl: tokenUrlInput.value.trim(),
                scope: scopeInput ? scopeInput.value.trim() : '',
                redirectUrl: redirectInput ? redirectInput.value.trim() : ''
            };

            if (!payload.authUrl || !payload.tokenUrl) {
                showStatus('Auth URL and Token URL are required', 'error');
                return;
            }

            resetOAuthState();
            updateOAuthStatus('Opening OAuth window...', 'pending');

            try {
                const response = await fetch('/api/oauth/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(errorBody.error || 'failed to start OAuth flow');
                }

                const data = await response.json();
                currentOAuthState = data.state;
                oauthPopup = window.open(
                    data.authorizationUrl,
                    'oauthPopup',
                    'width=520,height=720,menubar=no,toolbar=no,location=yes,status=no'
                );
                updateOAuthStatus('Waiting for provider authorization...', 'pending');
                beginOAuthPolling(data.state);
            } catch (error) {
                console.error('Failed to start OAuth flow', error);
                updateOAuthStatus('OAuth start failed', 'error');
                showStatus(`OAuth start failed: ${error.message}`, 'error');
            }
        }

        function beginOAuthPolling(state) {
            if (!state) {
                return;
            }
            oauthPollHandle = setInterval(async () => {
                try {
                    const response = await fetch(`/api/oauth/session/${state}`);
                    if (response.status === 202) {
                        updateOAuthStatus('Waiting for user confirmation...', 'pending');
                        return;
                    }
                    if (!response.ok) {
                        const errorBody = await response.json();
                        updateOAuthStatus('OAuth session failed', 'error');
                        showStatus(errorBody.error || 'OAuth session error', 'error');
                        clearInterval(oauthPollHandle);
                        oauthPollHandle = null;
                        return;
                    }
                    const data = await response.json();
                    handleOAuthSuccess(data);
                } catch (error) {
                    console.error('OAuth polling error', error);
                    updateOAuthStatus('OAuth polling error', 'error');
                    if (oauthPollHandle) {
                        clearInterval(oauthPollHandle);
                        oauthPollHandle = null;
                    }
                }
            }, 2000);
        }

        function handleOAuthSuccess(data) {
            if (oauthPollHandle) {
                clearInterval(oauthPollHandle);
                oauthPollHandle = null;
            }
            if (oauthPopup && !oauthPopup.closed) {
                oauthPopup.close();
            }
            const accessToken = document.getElementById('oauthAccessToken');
            const refreshToken = document.getElementById('oauthRefreshToken');
            const grantedScope = document.getElementById('oauthGrantedScope');
            const expiresAt = document.getElementById('oauthExpiresAt');
            const providerHidden = document.getElementById('oauthProviderName');
            const scopeInput = document.getElementById('oauthScopes');

            if (accessToken) {
                accessToken.value = data.accessToken || '';
            }
            if (refreshToken) {
                refreshToken.value = data.refreshToken || '';
            }
            if (grantedScope) {
                grantedScope.value = data.scope || '';
            }
            if (scopeInput && data.scope) {
                scopeInput.value = data.scope;
            }
            if (expiresAt) {
                expiresAt.value = data.expiresAt || '';
            }
            if (providerHidden && data.provider) {
                providerHidden.value = data.provider;
            }
            updateOAuthStatus('Connected via OAuth', 'success');
            showStatus('OAuth authorization completed', 'success');
        }

        function parseConfigEditor() {
            if (!configEditor) {
                return {};
            }
            const raw = configEditor.getValue();
            if (!raw || !raw.trim()) {
                return {};
            }
            try {
                return JSON.parse(raw);
            } catch (error) {
                throw new Error('Configuration JSON is invalid');
            }
        }

        function collectCredentialPayload() {
            if (!requireAuth.checked) {
                return null;
            }
            const type = credentialType.value;
            if (!type) {
                throw new Error('Select a credential type');
            }
            const getValue = (id, trim = true) => {
                const el = document.getElementById(id);
                if (!el) {
                    return '';
                }
                return trim ? el.value.trim() : el.value;
            };
            switch (type) {
                case 'api_key':
                    return {
                        type,
                        token: getValue('apiKey')
                    };
                case 'bearer':
                    return {
                        type,
                        token: getValue('bearerToken')
                    };
                case 'basic':
                    return {
                        type,
                        username: getValue('username'),
                        password: getValue('password', false)
                    };
                case 'oauth2':
                    return {
                        type,
                        clientId: getValue('clientId'),
                        clientSecret: getValue('clientSecret'),
                        authUrl: getValue('oauthAuthUrl'),
                        tokenUrl: getValue('oauthTokenUrl'),
                        scope: getValue('oauthScopes'),
                        redirectUrl: getValue('oauthRedirectUri'),
                        accessToken: getValue('oauthAccessToken'),
                        refreshToken: getValue('oauthRefreshToken'),
                        expiresAt: getValue('oauthExpiresAt')
                    };
                default:
                    throw new Error('Unsupported credential type');
            }
        }

        function buildIntegrationPayload() {
            const config = parseConfigEditor();
            const credential = collectCredentialPayload();
            return {
                name: integrationNameInput.value.trim(),
                type: integrationTypeSelect.value,
                description: integrationDescriptionInput.value.trim(),
                config,
                requireAuth: requireAuth.checked,
                credential
            };
        }

        function resetForm() {
            integrationIdInput.value = '';
            integrationNameInput.value = '';
            integrationTypeSelect.value = '';
            integrationDescriptionInput.value = '';
            requireAuth.checked = false;
            credentialType.value = '';
            credentialSection.classList.add('hidden');
            credentialFields.innerHTML = '';
            if (configEditor) {
                configEditor.setValue('{\n  \n}');
            }
            resetOAuthState();
            hideStatus();
        }

        function hideStatus() {
            if (statusMessage) {
                statusMessage.classList.add('hidden');
            }
        }

        function showStatus(message, type = 'info') {
            if (!statusMessage) {
                return;
            }
            const inner = statusMessage.querySelector('div');
            const palette = {
                info: 'bg-blue-100 border-blue-500 text-blue-700',
                success: 'bg-green-100 border-green-500 text-green-700',
                error: 'bg-red-100 border-red-500 text-red-700'
            };
            statusText.textContent = message;
            inner.className = `border-l-4 p-4 rounded ${palette[type] || palette.info}`;
            statusMessage.classList.remove('hidden');
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 6000);
        }

        integrationForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            try {
                const payload = buildIntegrationPayload();
                if (!payload.name || !payload.type) {
                    showStatus('Name and Type are required', 'error');
                    return;
                }
                const id = integrationIdInput.value;
                const method = id ? 'PUT' : 'POST';
                const url = id ? `/api/integrations/${id}` : '/api/integrations';
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to save integration');
                }
                showStatus('Integration saved successfully', 'success');
                resetForm();
                await loadIntegrations();
            } catch (error) {
                console.error('Failed to save integration', error);
                showStatus(error.message, 'error');
            }
        });

        addIntegrationBtn.addEventListener('click', () => {
            resetForm();
            integrationNameInput.focus();
        });

        requireAuth.addEventListener('change', () => {
            if (requireAuth.checked) {
                credentialSection.classList.remove('hidden');
                updateCredentialFields();
            } else {
                credentialSection.classList.add('hidden');
                credentialFields.innerHTML = '';
                resetOAuthState();
            }
        });

        credentialType.addEventListener('change', updateCredentialFields);

        searchInput.addEventListener('input', renderIntegrations);
        typeFilter.addEventListener('change', renderIntegrations);

        testBtn.addEventListener('click', () => {
            const id = integrationIdInput.value;
            if (id) {
                testIntegration(id);
            } else {
                showStatus('Select an integration to test', 'info');
            }
        });

        async function init() {
            await Promise.all([loadIntegrations(), loadOAuthProviders()]);
        }

        init();
    </script>
</body>

</html>
