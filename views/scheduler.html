<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETL Job Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>

<body class="bg-gradient-to-br from-purple-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900 mb-2">ETL Job Scheduler</h1>
                <p class="text-lg text-gray-600">Schedule and automate your ETL pipeline executions</p>
            </div>

            <!-- Navigation -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex flex-wrap justify-center space-x-4">
                    <a href="/"
                        class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition flex items-center">
                        <i data-lucide="home" class="w-4 h-4 mr-2"></i>
                        Dashboard
                    </a>
                    <a href="/integrations"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center">
                        <i data-lucide="plug" class="w-4 h-4 mr-2"></i>
                        Integrations
                    </a>
                    <a href="/etl"
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition flex items-center">
                        <i data-lucide="git-branch" class="w-4 h-4 mr-2"></i>
                        ETL Pipelines
                    </a>
                    <a href="/adapters"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center">
                        <i data-lucide="puzzle" class="w-4 h-4 mr-2"></i>
                        Adapters
                    </a>
                    <a href="/query"
                        class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition flex items-center">
                        <i data-lucide="database" class="w-4 h-4 mr-2"></i>
                        Query Editor
                    </a>
                    <a href="/scheduler"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition flex items-center">
                        <i data-lucide="calendar" class="w-4 h-4 mr-2"></i>
                        Scheduler
                    </a>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Create Schedule Form -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                            <i data-lucide="plus-circle" class="w-6 h-6 mr-2 text-indigo-600"></i>
                            Create Schedule
                        </h2>

                        <form id="scheduleForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pipeline</label>
                                <select id="pipelineSelect"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Select Pipeline</option>
                                    <option value="pipeline-1">Customer Data Pipeline</option>
                                    <option value="pipeline-2">Order Processing Pipeline</option>
                                    <option value="pipeline-3">Product Sync Pipeline</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Schedule Name</label>
                                <input type="text" id="scheduleName"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    placeholder="Daily Customer Sync">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Schedule Type</label>
                                <select id="scheduleType"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="cron">Cron Expression</option>
                                    <option value="interval">Interval</option>
                                    <option value="once">One-time</option>
                                </select>
                            </div>

                            <div id="cronSection">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cron Expression</label>
                                <input type="text" id="cronExpression"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    placeholder="0 */6 * * *">
                                <p class="text-xs text-gray-500 mt-1">Format: minute hour day month weekday</p>
                            </div>

                            <div id="intervalSection" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Interval</label>
                                <div class="flex space-x-2">
                                    <input type="number" id="intervalValue"
                                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        placeholder="30" min="1">
                                    <select id="intervalUnit"
                                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <option value="minutes">Minutes</option>
                                        <option value="hours">Hours</option>
                                        <option value="days">Days</option>
                                    </select>
                                </div>
                            </div>

                            <div id="onceSection" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Execution Time</label>
                                <input type="text" id="executionTime"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    placeholder="Select date and time">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Timezone</label>
                                <select id="timezone"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="UTC">UTC</option>
                                    <option value="America/New_York">America/New_York</option>
                                    <option value="Europe/London">Europe/London</option>
                                    <option value="Asia/Tokyo">Asia/Tokyo</option>
                                </select>
                            </div>

                            <div class="flex items-center">
                                <input type="checkbox" id="enabled"
                                    class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                                    checked>
                                <label for="enabled" class="ml-2 block text-sm text-gray-900">Enable schedule</label>
                            </div>

                            <div class="flex items-center">
                                <input type="checkbox" id="retryOnFailure"
                                    class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                <label for="retryOnFailure" class="ml-2 block text-sm text-gray-900">Retry on
                                    failure</label>
                            </div>

                            <div id="retryOptions" class="hidden space-y-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Max Retries</label>
                                    <input type="number" id="maxRetries"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        value="3" min="1" max="10">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Retry Delay
                                        (seconds)</label>
                                    <input type="number" id="retryDelay"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        value="60" min="10">
                                </div>
                            </div>

                            <button type="submit"
                                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md transition duration-200 flex items-center justify-center">
                                <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                                Create Schedule
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Scheduled Jobs List -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-2xl font-semibold text-gray-800 flex items-center">
                                <i data-lucide="calendar-clock" class="w-6 h-6 mr-2 text-purple-600"></i>
                                Scheduled Jobs
                            </h2>
                            <button id="refreshSchedulesBtn"
                                class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-md transition duration-200 flex items-center">
                                <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                                Refresh
                            </button>
                        </div>

                        <div id="scheduledJobs" class="space-y-4">
                            <!-- Scheduled jobs will be populated here -->
                        </div>
                    </div>

                    <!-- Execution History -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mt-8">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                            <i data-lucide="history" class="w-6 h-6 mr-2 text-blue-600"></i>
                            Execution History
                        </h2>
                        <div id="executionHistory" class="space-y-4">
                            <!-- Execution history will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Messages -->
            <div id="statusMessage" class="mt-8 hidden">
                <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded">
                    <div class="flex items-center">
                        <i data-lucide="info" class="w-5 h-5 mr-2"></i>
                        <span id="statusText"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // DOM elements
        const scheduleForm = document.getElementById('scheduleForm');
        const scheduleType = document.getElementById('scheduleType');
        const cronSection = document.getElementById('cronSection');
        const intervalSection = document.getElementById('intervalSection');
        const onceSection = document.getElementById('onceSection');
        const retryOnFailure = document.getElementById('retryOnFailure');
        const retryOptions = document.getElementById('retryOptions');
        const refreshSchedulesBtn = document.getElementById('refreshSchedulesBtn');
        const statusMessage = document.getElementById('statusMessage');
        const statusText = document.getElementById('statusText');

        // Initialize date picker
        flatpickr("#executionTime", {
            enableTime: true,
            dateFormat: "Y-m-d H:i",
            minDate: "today"
        });

        // Schedule type change handler
        scheduleType.addEventListener('change', () => {
            const type = scheduleType.value;

            // Hide all sections
            cronSection.classList.add('hidden');
            intervalSection.classList.add('hidden');
            onceSection.classList.add('hidden');

            // Show relevant section
            switch (type) {
                case 'cron':
                    cronSection.classList.remove('hidden');
                    break;
                case 'interval':
                    intervalSection.classList.remove('hidden');
                    break;
                case 'once':
                    onceSection.classList.remove('hidden');
                    break;
            }
        });

        // Retry on failure change handler
        retryOnFailure.addEventListener('change', () => {
            if (retryOnFailure.checked) {
                retryOptions.classList.remove('hidden');
            } else {
                retryOptions.classList.add('hidden');
            }
        });

        // Form submission handler
        scheduleForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const pipelineId = document.getElementById('pipelineSelect').value;
            const scheduleName = document.getElementById('scheduleName').value;
            const type = scheduleType.value;
            const timezone = document.getElementById('timezone').value;
            const enabled = document.getElementById('enabled').checked;
            const retry = retryOnFailure.checked;

            if (!pipelineId || !scheduleName) {
                showStatus('Please fill in all required fields', 'error');
                return;
            }

            let scheduleConfig = {};

            switch (type) {
                case 'cron':
                    const cronExpression = document.getElementById('cronExpression').value;
                    if (!cronExpression) {
                        showStatus('Please provide a cron expression', 'error');
                        return;
                    }
                    scheduleConfig = { cron: cronExpression };
                    break;
                case 'interval':
                    const intervalValue = document.getElementById('intervalValue').value;
                    const intervalUnit = document.getElementById('intervalUnit').value;
                    if (!intervalValue) {
                        showStatus('Please provide an interval value', 'error');
                        return;
                    }
                    scheduleConfig = { interval: `${intervalValue} ${intervalUnit}` };
                    break;
                case 'once':
                    const executionTime = document.getElementById('executionTime').value;
                    if (!executionTime) {
                        showStatus('Please select an execution time', 'error');
                        return;
                    }
                    scheduleConfig = { once: executionTime };
                    break;
            }

            const scheduleData = {
                pipelineId,
                name: scheduleName,
                type,
                schedule: scheduleConfig,
                timezone,
                enabled,
                retry: retry ? {
                    maxRetries: parseInt(document.getElementById('maxRetries').value),
                    retryDelay: parseInt(document.getElementById('retryDelay').value)
                } : null
            };

            try {
                const response = await fetch('/api/schedules', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(scheduleData)
                });

                if (response.ok) {
                    showStatus('Schedule created successfully', 'success');
                    scheduleForm.reset();
                    loadScheduledJobs();
                } else {
                    const error = await response.json();
                    showStatus(error.error || 'Failed to create schedule', 'error');
                }
            } catch (error) {
                console.error('Failed to create schedule:', error);
                showStatus('Failed to create schedule', 'error');
            }
        });

        // Load scheduled jobs
        async function loadScheduledJobs() {
            try {
                const response = await fetch('/api/schedules');
                const schedules = await response.json();

                const scheduledJobs = document.getElementById('scheduledJobs');

                if (schedules.length === 0) {
                    scheduledJobs.innerHTML = '<p class="text-gray-500 text-center py-8">No scheduled jobs found</p>';
                    return;
                }

                let html = '';
                schedules.forEach(schedule => {
                    const statusColor = schedule.enabled ? 'text-green-600' : 'text-gray-600';
                    const statusIcon = schedule.enabled ? 'check-circle' : 'pause-circle';
                    const nextRun = schedule.nextRun ? new Date(schedule.nextRun).toLocaleString() : 'N/A';

                    html += `
                        <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition duration-200">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center">
                                    <i data-lucide="${statusIcon}" class="w-5 h-5 mr-2 ${statusColor}"></i>
                                    <span class="font-semibold text-gray-800">${schedule.name}</span>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="toggleSchedule('${schedule.id}')" class="text-blue-600 hover:text-blue-800">
                                        <i data-lucide="${schedule.enabled ? 'pause' : 'play'}" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="editSchedule('${schedule.id}')" class="text-gray-600 hover:text-gray-800">
                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="deleteSchedule('${schedule.id}')" class="text-red-600 hover:text-red-800">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="text-sm text-gray-600 mb-1">
                                Pipeline: ${schedule.pipelineName}
                            </div>
                            <div class="text-sm text-gray-600 mb-1">
                                Schedule: ${formatSchedule(schedule.type, schedule.schedule)}
                            </div>
                            <div class="text-sm text-gray-600 mb-1">
                                Next Run: ${nextRun}
                            </div>
                            <div class="text-sm text-gray-600">
                                Timezone: ${schedule.timezone}
                            </div>
                        </div>
                    `;
                });

                scheduledJobs.innerHTML = html;
                lucide.createIcons();
            } catch (error) {
                console.error('Failed to load scheduled jobs:', error);
                document.getElementById('scheduledJobs').innerHTML = '<p class="text-red-500 text-center py-8">Failed to load scheduled jobs</p>';
            }
        }

        // Load execution history
        async function loadExecutionHistory() {
            try {
                const response = await fetch('/api/schedule-executions');
                const executions = await response.json();

                const executionHistory = document.getElementById('executionHistory');

                if (executions.length === 0) {
                    executionHistory.innerHTML = '<p class="text-gray-500 text-center py-8">No execution history found</p>';
                    return;
                }

                let html = '';
                executions.slice(0, 10).forEach(execution => {
                    const statusColor = getStatusColor(execution.status);
                    const statusIcon = getStatusIcon(execution.status);
                    const startTime = new Date(execution.startTime).toLocaleString();
                    const duration = execution.endTime ?
                        Math.round((new Date(execution.endTime) - new Date(execution.startTime)) / 1000) + 's' :
                        'Running';

                    html += `
                        <div class="border border-gray-200 rounded-lg p-3 hover:bg-gray-50 transition duration-200">
                            <div class="flex items-center justify-between mb-1">
                                <span class="font-medium text-gray-800">${execution.scheduleName}</span>
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColor} flex items-center">
                                    <i data-lucide="${statusIcon}" class="w-3 h-3 mr-1"></i>
                                    ${execution.status}
                                </span>
                            </div>
                            <div class="text-sm text-gray-600">
                                Started: ${startTime} | Duration: ${duration}
                            </div>
                            ${execution.error ? `<div class="text-sm text-red-600">Error: ${execution.error}</div>` : ''}
                        </div>
                    `;
                });

                executionHistory.innerHTML = html;
                lucide.createIcons();
            } catch (error) {
                console.error('Failed to load execution history:', error);
                document.getElementById('executionHistory').innerHTML = '<p class="text-red-500 text-center py-8">Failed to load execution history</p>';
            }
        }

        // Format schedule for display
        function formatSchedule(type, schedule) {
            switch (type) {
                case 'cron':
                    return `Cron: ${schedule.cron}`;
                case 'interval':
                    return `Every ${schedule.interval}`;
                case 'once':
                    return `Once: ${new Date(schedule.once).toLocaleString()}`;
                default:
                    return 'Unknown';
            }
        }

        // Toggle schedule
        async function toggleSchedule(id) {
            try {
                const response = await fetch(`/api/schedules/${id}/toggle`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showStatus('Schedule updated successfully', 'success');
                    loadScheduledJobs();
                } else {
                    const error = await response.json();
                    showStatus(error.error || 'Failed to update schedule', 'error');
                }
            } catch (error) {
                console.error('Failed to toggle schedule:', error);
                showStatus('Failed to update schedule', 'error');
            }
        }

        // Edit schedule
        function editSchedule(id) {
            showStatus('Edit functionality coming soon', 'info');
        }

        // Delete schedule
        async function deleteSchedule(id) {
            if (!confirm('Are you sure you want to delete this schedule?')) {
                return;
            }

            try {
                const response = await fetch(`/api/schedules/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showStatus('Schedule deleted successfully', 'success');
                    loadScheduledJobs();
                } else {
                    const error = await response.json();
                    showStatus(error.error || 'Failed to delete schedule', 'error');
                }
            } catch (error) {
                console.error('Failed to delete schedule:', error);
                showStatus('Failed to delete schedule', 'error');
            }
        }

        // Get status color
        function getStatusColor(status) {
            switch (status) {
                case 'completed': return 'bg-green-100 text-green-800';
                case 'running': return 'bg-blue-100 text-blue-800';
                case 'failed': return 'bg-red-100 text-red-800';
                case 'cancelled': return 'bg-gray-100 text-gray-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Get status icon
        function getStatusIcon(status) {
            switch (status) {
                case 'completed': return 'check-circle';
                case 'running': return 'loader';
                case 'failed': return 'x-circle';
                case 'cancelled': return 'ban';
                default: return 'clock';
            }
        }

        // Show status message
        function showStatus(message, type) {
            statusText.textContent = message;
            statusMessage.className = 'mt-8';

            if (type === 'error') {
                statusMessage.innerHTML = `
                    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded">
                        <div class="flex items-center">
                            <i data-lucide="alert-circle" class="w-5 h-5 mr-2"></i>
                            <span>${message}</span>
                        </div>
                    </div>
                `;
            } else if (type === 'success') {
                statusMessage.innerHTML = `
                    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded">
                        <div class="flex items-center">
                            <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>
                            <span>${message}</span>
                        </div>
                    </div>
                `;
            } else {
                statusMessage.innerHTML = `
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded">
                        <div class="flex items-center">
                            <i data-lucide="info" class="w-5 h-5 mr-2"></i>
                            <span>${message}</span>
                        </div>
                    </div>
                `;
            }

            lucide.createIcons();

            setTimeout(() => {
                statusMessage.className = 'mt-8 hidden';
            }, 5000);
        }

        // Event listeners
        refreshSchedulesBtn.addEventListener('click', () => {
            loadScheduledJobs();
            loadExecutionHistory();
            showStatus('Schedules refreshed', 'success');
        });

        // Initialize
        loadScheduledJobs();
        loadExecutionHistory();
    </script>
</body>

</html>
